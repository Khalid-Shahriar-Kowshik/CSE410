{% load static %}
<section>
  <!-- Top Utility Bar -->
  <div class="bg-dark text-white py-2" style="background-color: #212529 !important;">
    <div class="container d-flex justify-content-between align-items-center">
      <!-- Centered Logo and Title -->
      <div class="mx-auto d-flex align-items-center">
        <img src="{% static 'image/logo.png' %}" alt="Site Logo"
             style="height: 30px; margin-right: 10px;"
             class="d-inline-block align-text-top">
        <span class="fw-bold fs-5">HardwarePickerBD</span>
      </div>

      <!-- Auth Buttons with Conditional Logic -->
      <div class="position-absolute end-0 me-3">
        {% if user.is_authenticated %}
          <div class="d-flex align-items-center">
            <a href="{% url 'profile' %}" class="btn btn-sm btn-light text-dark me-2">
              <i class="fas fa-user me-1"></i>{{ user.username }}
            </a>
            <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-light">
              <i class="fa-solid fa-door-open"></i> Logout
            </a>
          </div>
        {% else %}
          <div class="d-flex">
            <a href="{% url 'register' %}" class="btn btn-sm btn-outline-light me-2">
              <i class="fas fa-user-plus me-1"></i>Register
            </a>
            <a href="{% url 'login' %}" class="btn btn-sm btn-light text-dark">
              <i class="fas fa-sign-in-alt me-1"></i>Login
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

 <!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #191b2a !important;">
  <div class="container-fluid">
    <!-- Logo/Home Link -->
    <a class="navbar-brand me-3" href="{% url 'home' %}">
      <i class="fa-solid fa-house"></i>
    </a>

    <!-- Toggler -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navbar Items -->
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'cpu' %}">
            <i class="fas fa-tools me-1"></i>Builder
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'guide_list' %}">
            <i class="fas fa-book me-1"></i>Guides
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'blog' %}">
            <i class="fa-solid fa-users me-1"></i>  BuildHub
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'cart_view' %}">
            <i class="fas fa-shopping-cart me-1"></i>Cart
            {% if cart_count > 0 %}
              <span class="badge bg-danger ms-1">{{ cart_count }}</span>
            {% endif %}
          </a>
        </li>
      </ul>
     
     <!-- Modified search form with MODE SWITCHER -->
<form id="unified-search-form" class="d-flex ms-auto position-relative align-items-center" role="search" method="get" action="{% url 'product_search' %}">
    
    <!-- Search Mode Switcher (replaces toggle) -->
    <div class="search-mode-switcher me-2">
        <button type="button" class="mode-btn active" data-mode="products">
            <i class="bi bi-box-seam me-1"></i>Products
        </button>
        <button type="button" class="mode-btn" data-mode="blog">
            <i class="bi bi-newspaper me-1"></i>Blog
        </button>
    </div>

    <!-- Search Input and Button -->
    <div class="input-group">
        <input id="unified-search-input" class="form-control form-control-sm" type="search" placeholder="Search products" aria-label="Search" name="q" autocomplete="off" value="{{ request.GET.q|default_if_none:'' }}">
        <button class="btn btn-outline-light btn-sm" type="submit">
            <i class="bi bi-search"></i>
        </button>
    </div>
    
    <!-- Autocomplete dropdown container -->
    <div id="unified-autocomplete-dropdown" class="list-group position-absolute" style="z-index: 1051; display: none; right: 0; left: auto; width: 320px; top: 38px;">
        <!-- Suggestions will be injected here -->
    </div>
</form>
    </div>
  </div>
</nav>
  <!-- Navbar End -->

</section>

<style>
  /* === Top Utility Bar Button Styling === */
  .bg-dark .btn-sm {
    padding: 6px 16px !important;
    font-size: 0.875rem !important;
    border-width: 1px !important;
    border-radius: 6px !important;
    line-height: 1.5 !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    margin: 0 !important;
  }

  .bg-dark .btn-outline-light {
    border: 1px solid rgba(255,255,255,0.8) !important;
    color: #fff !important;
    background-color: transparent !important;
  }

  .bg-dark .btn-outline-light:hover {
    background-color: rgba(255,255,255,0.15) !important;
    border-color: #fff !important;
    color: #fff !important;
  }

  .bg-dark .btn-light {
    background-color: #f8f9fa !important;
    border: 1px solid #f8f9fa !important;
    color: #212529 !important;
  }

  .bg-dark .btn-light:hover {
    background-color: #e2e6ea !important;
    border-color: #dae0e5 !important;
    color: #212529 !important;
  }

  .bg-dark .me-2 {
    margin-right: 8px !important;
  }

  /* Navbar Nav Link Styling */
  .navbar-nav .nav-link {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
    border-radius: 4px;
  }

  .navbar-nav .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }

  .navbar-nav .nav-item {
    margin: 0 5px;
  }

  .navbar-toggler {
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  /* Search Mode Switcher Styling */
  .search-mode-switcher {
    display: flex;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 3px;
    gap: 2px;
  }

  .mode-btn {
    border: none;
    background: transparent;
    color: rgba(255, 255, 255, 0.6);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .mode-btn:hover {
    color: rgba(255, 255, 255, 0.9);
    background-color: rgba(255, 255, 255, 0.05);
  }

  .mode-btn.active {
    background-color: rgba(255, 255, 255, 0.2);
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .mode-btn i {
    font-size: 0.9rem;
  }

  /* Search Form Styling */
  .form-control {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
  }

  .form-control:focus {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.1);
  }

  .form-control::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  .btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  /* Autocomplete dropdown tweaks */
  #unified-autocomplete-dropdown .list-group-item { 
    cursor: pointer; 
  }
  
  #unified-autocomplete-dropdown .small { 
    font-size: 11px; 
  }
  
  @media (max-width: 576px){
    #unified-autocomplete-dropdown{
      width:calc(100vw - 40px);
      right:unset;
      left:8px;
    }
    
    .search-mode-switcher {
      margin-bottom: 8px;
    }
    
    .mode-btn {
      font-size: 0.75rem;
      padding: 5px 8px;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('unified-search-form');
    const searchInput = document.getElementById('unified-search-input');
    const dropdown = document.getElementById('unified-autocomplete-dropdown');
    const modeButtons = document.querySelectorAll('.mode-btn');
    let currentMode = 'products';
    let activeIndex = -1;

    // --- Mode Switcher Logic ---
    modeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            modeButtons.forEach(b => b.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get the selected mode
            currentMode = this.dataset.mode;
            const isBlogSearch = currentMode === 'blog';
            
            // Update form action and placeholder
            searchForm.action = isBlogSearch ? "{% url 'blog_search' %}" : "{% url 'product_search' %}";
            searchInput.placeholder = isBlogSearch ? "Search blog posts..." : "Search products...";
            searchInput.value = ''; // Clear input on mode change
            dropdown.style.display = 'none'; // Clear dropdown
        });
    });

    // --- Debounce function to limit API calls ---
    function debounce(fn, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    // --- Fetch and Render Autocomplete Suggestions ---
    async function fetchSuggestions(query) {
        if (!query) {
            render([]); // Clear dropdown if query is empty
            return;
        }

        // Determine which API to call based on the current mode
        const isBlogSearch = currentMode === 'blog';
        const url = isBlogSearch 
            ? `{% url "blog_autocomplete" %}?term=${encodeURIComponent(query)}`
            : `{% url "product_autocomplete" %}?q=${encodeURIComponent(query)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                render([]);
                return;
            }
            const data = await response.json();
            // Handle both {results: []} and [] formats
            render(data.results || data);
        } catch (error) {
            console.error('Autocomplete fetch error:', error);
            render([]);
        }
    }

    function render(items) {
        dropdown.innerHTML = '';
        if (!items || items.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        items.forEach((item, index) => {
            const a = document.createElement('a');
            a.href = item.url;
            a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            a.setAttribute('data-index', index);

            const name = item.name || item.label;
            const thumb = item.thumbnail ? `<img src="${item.thumbnail}" alt="" style="width:48px;height:48px;object-fit:cover;border-radius:4px;margin-right:10px;">` : '';
            const type = item.type ? `<div class="small text-muted">${item.type}</div>` : '';
            const price = item.price ? `<div class="small text-muted">à§³ ${item.price}</div>` : '';
            
            a.innerHTML = `<div class="d-flex align-items-center">${thumb}<div><strong>${name}</strong>${type}</div></div>${price}`;
            dropdown.appendChild(a);
        });

        activeIndex = -1;
        dropdown.style.display = 'block';
    }

    // --- Event Listeners ---
    const debouncedFetch = debounce(e => fetchSuggestions(e.target.value.trim()), 250);
    searchInput.addEventListener('input', debouncedFetch);

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (dropdown.style.display === 'none') return;

        const items = dropdown.children;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = Math.min(items.length - 1, activeIndex + 1);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = Math.max(0, activeIndex - 1);
        } else if (e.key === 'Enter') {
            if (activeIndex >= 0 && items[activeIndex]) {
                e.preventDefault();
                items[activeIndex].click();
            }
        } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
        }
        
        Array.from(items).forEach((item, i) => item.classList.toggle('active', i === activeIndex));
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchForm.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});
</script>
